<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finalizar Compra - HuertoHogar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/CSS/Estilo.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
</head>

<body class="bg-light">
  <nav class="navbar navbar-expand-sm navbar-huerto fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="./index.html">
           <img src="/Img/LogoHuerto.png" alt="logo huerto" width="45" height="45" class="me-2" />
        <span class="brand-text">HuertoHogar</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mynavbar">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mynavbar">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="./index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="./Productos.html">Productos</a></li>
          <li class="nav-item"><a class="nav-link" href="./Recetas.html">Recetas</a></li>
          <li class="nav-item"><a class="nav-link" href="./Contacto.html">Contacto</a></li>
          <li class="nav-item"><a class="nav-link" href="./Quienes_Somos.html">Quienes Somos</a></li>
        </ul>

        <form class="d-flex align-items-center">
          <input id="buscar-input" class="form-control me-2" type="text" placeholder="Buscar producto..." />
          <button id="btn-buscar" class="btn btn-huerto me-3" type="button">Buscar</button>

          <a href="./Carrito_Compra.html" class="icon-link me-3 position-relative" title="Carrito">
            <i class="bi bi-cart3 fs-4"></i>
            <span id="carrito-count" class="badge bg-success position-absolute">0</span>
          </a>

          <a href="./Mi_Cuenta.html" class="icon-link position-relative" title="Mi Cuenta">
            <i class="bi bi-person-circle fs-4"></i>
          </a>
        </form>
      </div>
    </div>
  </nav>

  <main class="container py-5 mt-5">
    <h2 class="text-center mb-4">üßæ Finalizar Compra</h2>

    <div id="modo-compra" class="text-center mb-4">
      <h5>¬øC√≥mo deseas continuar?</h5>
      <button id="btn-iniciar-sesion" class="btn btn-outline-primary m-2">Iniciar sesi√≥n</button>
      <button id="btn-invitado" class="btn btn-outline-success m-2">Continuar como invitado</button>
    </div>

    <div id="login-box" class="d-none text-center mb-5">
      <h5 class="mb-3 text-success">Iniciar sesi√≥n</h5>
      <input type="email" id="correo-login" class="form-control w-50 mx-auto mb-2" placeholder="Correo electr√≥nico">
      <input type="password" id="pass-login" class="form-control w-50 mx-auto mb-3" placeholder="Contrase√±a">
      <button id="btn-login" class="btn btn-success">Ingresar</button>
      <p class="mt-3"><a href="#" id="volver-elegir" class="text-secondary">Volver</a></p>
    </div>

    <div id="checkout-container" class="row d-none justify-content-center">
      <div class="col-md-6">
        <div class="card p-4 shadow-sm">
          <h4>Datos del comprador</h4>
          <form id="checkout-form">
            <div class="mb-3">
              <label class="form-label">Nombre completo</label>
              <input type="text" id="nombre" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Direcci√≥n de env√≠o</label>
              <input type="text" id="direccion" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">M√©todo de pago</label>
              <select id="metodoPago" class="form-select" required>
                <option value="">Seleccione...</option>
                <option value="tarjeta">Tarjeta de cr√©dito / d√©bito</option>
                <option value="transferencia">Transferencia bancaria</option>
                <option value="efectivo">Pago en efectivo</option>
              </select>
            </div>
            <button type="submit" class="btn btn-success w-100">Finalizar Compra</button>
          </form>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card p-4 shadow-sm">
          <h4>Resumen del pedido</h4>
          <div id="resumen-carrito" class="border rounded p-3 bg-light"></div>
          <h4 class="mt-3 text-end text-success">Total: <span id="total-checkout">$0</span></h4>
        </div>
      </div>
    </div>

    <div id="boleta" class="mt-5 d-none">
      <div class="card shadow p-4">
        <h3 class="text-center text-success mb-3">‚úÖ Compra realizada con √©xito</h3>
        <div id="boleta-contenido"></div>
        <div class="text-center mt-3">
          <button class="btn btn-outline-primary me-2" id="btn-descargar">
            <i class="bi bi-download"></i> Descargar Boleta (PDF)
          </button>
          <button class="btn btn-outline-secondary" id="btn-imprimir">
            <i class="bi bi-printer"></i> Imprimir
          </button>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer-custom text-white pt-4 pb-2">
    <div class="row px-5">
      <div class="col-md-4 mb-3">
        <h5>Contacto</h5>
        <p>Email: contacto@huertohogar.cl</p>
        <p>Tel: +56 9 1234 5678</p>
        <p>Direcci√≥n: Calle Ejemplo 123, Concepci√≥n, Chile</p>
      </div>

      <div class="col-md-4 mb-3">
        <h5>Enlaces √∫tiles</h5>
        <ul class="list-unstyled">
          <li><a href="./index.html" class="text-white text-decoration-none">Inicio</a></li>
          <li><a href="./Productos.html" class="text-white text-decoration-none">Productos</a></li>
          <li><a href="./Recetas.html" class="text-white text-decoration-none">Recetas</a></li>
          <li><a href="https://github.com/xRaven28/HuertoHogar.git" class="text-white text-decoration-none">GitHub</a></li>
        </ul>
      </div>

      <div class="col-md-4 mb-3">
        <h5>S√≠guenos</h5>
        <a href="#" class="text-white me-2"><i class="bi bi-facebook"></i> Facebook</a><br>
        <a href="#" class="text-white me-2"><i class="bi bi-instagram"></i> Instagram</a><br>
        <a href="#" class="text-white me-2"><i class="bi bi-whatsapp"></i> WhatsApp</a>
      </div>
    </div>
    <hr class="bg-white mx-5">
    <p class="text-center mb-0">&copy; 2025 Huerto Hogar. Todos los derechos reservados.</p>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const { jsPDF } = window.jspdf;
    const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
    let usuario = JSON.parse(localStorage.getItem("usuarioActual")) || JSON.parse(sessionStorage.getItem("usuarioActual"));

    const resumenDiv = document.getElementById("resumen-carrito");
    const totalEl = document.getElementById("total-checkout");

    if (carrito.length === 0) {
      document.querySelector("main").innerHTML = "<h4 class='text-center text-danger'>Tu carrito est√° vac√≠o üõí</h4>";
    }

    const modoBox = document.getElementById("modo-compra");
    const checkoutBox = document.getElementById("checkout-container");
    const loginBox = document.getElementById("login-box");

    function mostrarCheckout() {
      modoBox.classList.add("d-none");
      loginBox.classList.add("d-none");
      checkoutBox.classList.remove("d-none");
      cargarResumen();
      if (usuario) {
        document.getElementById("nombre").value = usuario.nombre || "";
        if (usuario.direccion) document.getElementById("direccion").value = usuario.direccion;
      }
    }

    if (usuario) mostrarCheckout();

    document.getElementById("btn-invitado").addEventListener("click", mostrarCheckout);
    document.getElementById("btn-iniciar-sesion").addEventListener("click", () => {
      modoBox.classList.add("d-none");
      loginBox.classList.remove("d-none");
    });
    document.getElementById("volver-elegir").addEventListener("click", () => {
      loginBox.classList.add("d-none");
      modoBox.classList.remove("d-none");
    });

    document.getElementById("btn-login").addEventListener("click", () => {
      const correo = document.getElementById("correo-login").value.trim();
      const pass = document.getElementById("pass-login").value.trim();
      const usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];
      const u = usuarios.find(x => x.correo === correo && x.password === pass);
      if (!u) return alert("Credenciales incorrectas");
      localStorage.setItem("usuarioActual", JSON.stringify(u));
      usuario = u;
      alert(`Bienvenido ${u.nombre}`);
      mostrarCheckout();
    });

    function cargarResumen() {
      let total = 0;
      resumenDiv.innerHTML = carrito.map(p => {
        const subtotal = p.precio * p.cantidad;
        total += subtotal;
        return `<div class="d-flex justify-content-between border-bottom py-2"><span>${p.name} x${p.cantidad}</span><span>$${subtotal.toLocaleString("es-CL")}</span></div>`;
      }).join("");
      totalEl.textContent = "$" + total.toLocaleString("es-CL");
    }

    document.getElementById("checkout-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const nombre = document.getElementById("nombre").value.trim();
      const direccion = document.getElementById("direccion").value.trim();
      const metodo = document.getElementById("metodoPago").value;
      if (!nombre || !direccion || !metodo) return alert("Por favor completa todos los campos.");

      const total = carrito.reduce((acc, p) => acc + p.precio * p.cantidad, 0);
      const fecha = new Date();
      const codigo = `HH-${fecha.getFullYear()}${String(fecha.getMonth() + 1).padStart(2, "0")}${String(fecha.getDate()).padStart(2, "0")}-${fecha.getTime()}`;

      const boleta = {
        codigo,
        cliente: nombre,
        direccion,
        metodoPago: metodo,
        productos: carrito,
        total,
        fecha: fecha.toLocaleString()
      };

      const historial = JSON.parse(localStorage.getItem("historialCompras")) || [];
      historial.push(boleta);
      localStorage.setItem("historialCompras", JSON.stringify(historial));

      localStorage.removeItem("carrito");

      checkoutBox.classList.add("d-none");
      document.getElementById("boleta-contenido").innerHTML = `
        <p><strong>N¬∞ Boleta:</strong> ${boleta.codigo}</p>
        <p><strong>Cliente:</strong> ${boleta.cliente}</p>
        <p><strong>Direcci√≥n:</strong> ${boleta.direccion}</p>
        <p><strong>M√©todo de pago:</strong> ${boleta.metodoPago}</p>
        <p><strong>Fecha:</strong> ${boleta.fecha}</p>
        <hr>
        <h5>Detalle de compra:</h5>
        <ul>${boleta.productos.map(p => `<li>${p.name} x${p.cantidad} - $${(p.precio * p.cantidad).toLocaleString("es-CL")}</li>`).join("")}</ul>
        <h4 class="text-end mt-3 text-success">Total: $${boleta.total.toLocaleString("es-CL")}</h4>
      `;
      document.getElementById("boleta").classList.remove("d-none");

      document.getElementById("btn-descargar").addEventListener("click", () => {
        const doc = new jsPDF();
        doc.text("HuertoHogar - Boleta de Compra", 10, 10);
        doc.text(`Boleta N¬∞: ${boleta.codigo}`, 10, 20);
        doc.text(`Cliente: ${boleta.cliente}`, 10, 30);
        doc.text(`Direcci√≥n: ${boleta.direccion}`, 10, 40);
        doc.text(`M√©todo de pago: ${boleta.metodoPago}`, 10, 50);
        doc.text(`Fecha: ${boleta.fecha}`, 10, 60);
        let y = 70;
        boleta.productos.forEach(p => {
          doc.text(`${p.name} x${p.cantidad} - $${(p.precio * p.cantidad).toLocaleString("es-CL")}`, 10, y);
          y += 10;
        });
        doc.text(`Total: $${boleta.total.toLocaleString("es-CL")}`, 10, y + 10);
        doc.save(`Boleta_${boleta.codigo}.pdf`);
      });

      document.getElementById("btn-imprimir").addEventListener("click", () => window.print());
    });
  </script>
</body>
</html>